<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador IDE Virtual</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/matchesonscrollbar.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/matchesonscrollbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/scroll/annotatescrollbar.min.js"></script>

    <style>
        :root {
            /* Tema Escuro Inspirado no css.txt */
            --bg-color: #2c2c2c;          
            --header-bg: #1e1e1e;         
            --item-bg: #3a3a3a;          
            --item-hover-bg: #4a4a4a;     
            --border-color: #555;         
            --text-color: #e0e0e0;        
            --text-muted: #aaa;         
            --text-light: #f1f1f1;        
            --modal-bg: #424242;          
            --modal-header-border: #666;
            --modal-text: var(--text-color);
            --modal-input-bg: #555;
            --modal-input-border: #777;
            
            /* Cores dos botões */
            --run-button-color: #4CAF50;  
            --mode-button-color: #007bff; 
            --analysis-button-color: #9b59b6;
            --goto-button-color: #1abc9c;
            --save-button-color: #f39c12; 
            --clear-button-color: #e67e22;
            --device-button-color: #6c757d; 
            --back-button-color: var(--device-button-color);
            --delete-btn-color: #dc3545; 
            --import-button-color: #5bc0de; /* Azul claro para importar */

            /* Cores dos Ícones */
            --folder-icon-color: #007bff; 
            --js-icon-color: #f0db4f;    
            --html-icon-color: #e34c26;   

            /* Cores do Editor/Console */
            --editor-bg: #272227;       
            --console-bg: #1e1e1e;
            --console-text: #d4d4d4;
            --error-line-bg: #5a1d1d;
            --suggestion-line-bg: #5a5a1d;
            --output-warn: #f1c40f;
            --output-error: #e74c3c;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden; 
            font-size: 14px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .hide { display: none !important; }

        button { cursor: pointer; }

        /* ----------------------------------- */
        /* CABEÇALHO (Compartilhado) */
        /* ----------------------------------- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px;
            background-color: var(--header-bg);
            color: var(--text-light);
            flex-shrink: 0; 
            border-bottom: 1px solid var(--border-color);
        }
        .header h1 { font-size: 1.5em; margin: 0; }
        .header-buttons { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
        .header-buttons button {
            color: white; border: none; padding: 8px 12px;
            border-radius: 5px; font-weight: bold;
            transition: background-color 0.2s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        #run-button { background-color: var(--run-button-color); }
        #analyze-button { background-color: var(--analysis-button-color); }
        #goto-visual-button, #goto-script-button { background-color: var(--goto-button-color); }
        #save-button { background-color: var(--save-button-color); }
        #back-button { background-color: var(--back-button-color); }
        #new-folder-btn { background-color: var(--goto-button-color); }
        #new-file-btn { background-color: var(--mode-button-color); }
        #import-file-btn { background-color: var(--import-button-color); }

        /* ----------------------------------- */
        /* TELA 1: DASHBOARD */
        /* ----------------------------------- */
        #dashboard-page { display: flex; flex-direction: column; height: 100vh; }
        .dashboard-controls {
            padding: 15px 20px;
            background: var(--item-bg);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .dashboard-controls .breadcrumb { font-size: 1.1em; color: var(--text-muted); }
        .breadcrumb span { cursor: pointer; color: var(--text-color); }
        .breadcrumb span:hover { text-decoration: underline; color: var(--text-light); }
        
        #layout-toggle-btn {
            background: none; border: 1px solid var(--border-color);
            color: var(--text-muted); padding: 5px 10px;
            border-radius: 5px; font-size: 1.1em;
        }
         #layout-toggle-btn:hover { background-color: var(--item-hover-bg); color: var(--text-light); }
        
        .file-browser { flex-grow: 1; overflow-y: auto; padding: 20px; }
        #file-list {
            list-style: none; padding: 0; margin: 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 20px;
        }
        #file-list.list-view {
            display: flex;
            flex-direction: column;
            gap: 10px; 
        }
        #file-list.list-view .file-item {
            flex-direction: row; justify-content: flex-start;
            text-align: left; padding: 12px 15px; 
        }
         #file-list.list-view .file-item .file-icon {
            font-size: 1.2em; margin-bottom: 0;
            margin-right: 15px; width: 20px; text-align: center;
         }
         #file-list.list-view .file-item .file-name { flex-grow: 1; max-height: none; }
         #file-list.list-view .file-item .file-actions {
             position: static; opacity: 1; margin-left: auto; 
         }
         #file-list.list-view .file-item:hover .file-actions { opacity: 1; }
         #file-list.list-view .file-item .file-actions button {
             background: none; color: var(--text-muted); padding: 5px; margin-left: 5px;
         }
         #file-list.list-view .file-item .file-actions button:hover { background: none; color: var(--text-light); }
         #file-list.list-view .file-item .file-actions .delete-btn:hover { color: var(--delete-btn-color); }

        .file-item { 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            text-align: center; padding: 20px 15px;
            background: var(--item-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            position: relative; 
        }
        .file-item:hover { background-color: var(--item-hover-bg); transform: translateY(-2px); }
        .file-item .file-icon { font-size: 2.5em; margin-bottom: 15px; }
        .file-item .fa-folder { color: var(--folder-icon-color); }
        .file-item .fa-js-square { color: var(--js-icon-color); }
        .file-item .fa-html5 { color: var(--html-icon-color); }
        
        .file-item .file-name {
            font-weight: 500; word-break: break-all; 
            max-height: 3.6em; overflow: hidden;
            color: var(--text-color);
        }
        .file-item .file-actions {
            position: absolute; top: 5px; right: 5px;
            display: flex; gap: 5px; opacity: 0; 
            transition: opacity 0.2s;
        }
        .file-item:hover .file-actions { opacity: 1; }
        .file-item .file-actions button {
            background: rgba(0,0,0,0.3); border: none;
            cursor: pointer; font-size: 0.9em;
            color: var(--text-light); padding: 5px 7px;
            border-radius: 4px;
        }
        .file-item .file-actions button:hover { background: rgba(0,0,0,0.5); }
        .file-item .file-actions .delete-btn:hover { background-color: var(--delete-btn-color); }

        #file-importer { display: none; }

        /* ----------------------------------- */
        /* TELA 2: EDITOR */
        /* ----------------------------------- */
         #editor-page { display: flex; flex-direction: column; height: 100vh; }
        .editor-area-wrapper { flex-grow: 1; overflow: hidden; position: relative; }
        .CodeMirror { height: 100% !important; font-size: 15px; line-height: 1.5; font-family: 'Consolas', 'Courier New', monospace; }
        .line-error-background { background-color: var(--error-line-bg); }
        .line-suggestion-background { background-color: var(--suggestion-line-bg); }
        #search-bar { position: absolute; top: 5px; right: 10px; z-index: 10; background: #333; color: #f1f1f1; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .search-row { display: flex; align-items: center; margin-bottom: 8px; }
        .search-row label { width: 80px; font-size: 0.9em; }
        .search-row input { background: #555; color: #f1f1f1; border: 1px solid #777; outline: none; padding: 4px; border-radius: 3px; width: 200px; }
        .search-buttons { display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; }
        .search-buttons button { background: #666; color: #f1f1f1; border: 1px solid #888; padding: 3px 8px; border-radius: 3px; cursor: pointer; }
        .search-buttons button:hover { background: #777; }
        .search-buttons .search-main-action { background-color: var(--mode-button-color); border-color: var(--mode-button-color); }
        .CodeMirror-search-match { background: yellow; opacity: 0.4; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--modal-bg); color: var(--modal-text); border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); width: 90vw; height: 85vh; padding: 20px; position: relative; display: flex; flex-direction: column; box-sizing: border-box; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--modal-header-border); padding-bottom: 10px; flex-shrink: 0; }
        .modal-header h2 { margin: 0; font-size: 1.3em; color: var(--text-light); }
        .modal-header-buttons { display: flex; align-items: center; }
        .modal-header-buttons button { background: var(--item-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; cursor: pointer; padding: 5px 10px; margin-left: 8px; font-size: 0.9em; display: inline-flex; align-items: center; gap: 6px; }
        .modal-header-buttons button:hover { background-color: var(--item-hover-bg); }
        #clear-console-button { color: var(--clear-button-color); border-color: var(--clear-button-color); }
        #close-modal-button { color: var(--text-muted); }
        #toggle-device-button { color: var(--device-button-color); border-color: var(--device-button-color); display: none; }
        .modal-body { flex-grow: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; background: var(--bg-color); border-radius: 5px; }
        #output-console-modal, #output-analysis-modal, #output-html-modal { display: none; }
        #output-console-modal { background-color: var(--console-bg); color: var(--console-text); padding: 15px; overflow-y: auto; white-space: pre-wrap; font-family: 'Consolas', 'Courier New', monospace; font-size: 1em; border-radius: 4px; width: 100%; height: 100%; box-sizing: border-box; flex-grow: 1; border: none; }
        #output-analysis-modal { background-color: var(--item-bg); color: var(--text-color); border: none; padding: 25px; overflow-y: auto; font-family: 'Arial', sans-serif; font-size: 1em; border-radius: 4px; width: 100%; height: 100%; box-sizing: border-box; flex-grow: 1; line-height: 1.6; }
        #output-analysis-modal h3 { color: var(--analysis-button-color); border-bottom: 2px solid var(--border-color); padding-bottom: 5px; }
        #output-analysis-modal ul { list-style: none; padding-left: 0; }
        #output-analysis-modal li { padding: 10px; border-bottom: 1px solid var(--border-color); }
        #output-analysis-modal .line-ref { background: var(--bg-color); color: var(--text-color); padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        #output-html-modal { width: 100%; height: 100%; border: none; background-color: white; flex-grow: 1; transition: all 0.3s ease-in-out; }
        #output-html-modal.mobile-view { width: 375px; height: 667px; border: 12px solid #1e1e1e; border-radius: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); flex-grow: 0; }
        .output-line { padding: 2px 0; border-bottom: 1px solid #444; }
        .output-line:last-child { border-bottom: none; }
        #executor-iframe { display: none; }
    </style>
</head>
<body>

    <div id="dashboard-page">
        <header class="header">
            <h1><i class="fas fa-archive"></i> Meus Projetos</h1>
            <div class="header-buttons">
                 <button id="new-folder-btn"><i class="fas fa-folder-plus"></i> Nova Pasta</button>
                 <button id="new-file-btn"><i class="fas fa-file-plus"></i> Novo Arquivo</button>
                 <button id="import-file-btn"><i class="fas fa-upload"></i> Importar</button>
                 <input type="file" id="file-importer" accept=".js,.html,.htm">
            </div>
        </header>
        
        <div class="dashboard-controls">
            <div id="breadcrumb-bar" class="breadcrumb"></div>
            <button id="layout-toggle-btn" title="Alternar Layout"><i class="fas fa-th"></i></button>
        </div>
        
        <div class="file-browser">
            <ul id="file-list">
                </ul>
        </div>
    </div>
    
    <div id="editor-page" class="hide">
         <header class="header">
            <div style="display: flex; align-items: center;">
                <button id="back-button" title="Voltar ao Dashboard"><i class="fas fa-arrow-left"></i> Voltar</button>
                <h1 id="editor-filename" style="margin-left: 20px; font-size: 1.5em;"></h1>
            </div>
            <div class="header-buttons">
                <button id="save-button" title="Salvar no dispositivo"><i class="fas fa-save"></i> Salvar</button>
                <button id="goto-visual-button" title="Ir para parte visual (HTML)" class="hide"><i class="fas fa-palette"></i> Visual</button>
                <button id="goto-script-button" title="Ir para script (HTML)" class="hide"><i class="fas fa-code"></i> Script</button>
                <button id="analyze-button" title="Analisar código (Linter)"><i class="fas fa-search"></i> Analisar</button>
                <button id="run-button"><i class="fas fa-play"></i> RUN</button>
            </div>
        </header>
        <div class="editor-area-wrapper" id="editor-container-wrapper">
             <div id="search-bar" class="hide">
                <div class="search-row"><label for="search-input">Buscar:</label><input type="text" id="search-input"></div>
                <div class="search-row hide" id="replace-row"><label for="replace-input">Substituir:</label><input type="text" id="replace-input"></div>
                <div class="search-buttons">
                    <button id="search-prev" title="Anterior"><i class="fas fa-arrow-up"></i></button>
                    <button id="search-next" title="Próximo"><i class="fas fa-arrow-down"></i></button>
                    <button id="replace-one" title="Substituir" class="hide search-main-action">Substituir</button>
                    <button id="replace-all" title="Substituir Todos" class="hide search-main-action">Subst. Todos</button>
                    <button id="search-close" title="Fechar (Esc)"><i class="fas fa-times"></i></button>
                </div>
            </div>
        </div>
        <iframe id="executor-iframe" sandbox="allow-scripts"></iframe>
        <div id="result-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modal-title">Resultado</h2> 
                    <div class="modal-header-buttons">
                        <button id="toggle-device-button" title="Alternar Visualização"><i class="fas fa-mobile-alt"></i> Celular</button>
                        <button id="clear-console-button" title="Limpar Console"><i class="fas fa-ban"></i> Limpar</button>
                        <button id="close-modal-button" title="Fechar"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="modal-body">
                    <pre id="output-console-modal"></pre>
                    <iframe id="output-html-modal" sandbox="allow-scripts allow-forms allow-popups"></iframe>
                    <div id="output-analysis-modal"></div>
                </div>
            </div>
        </div>
    </div> <script>
        // =================================================================
        // VARIÁVEIS GLOBAIS E CONSTANTES DO EDITOR
        // =================================================================
        const dashboardPage = document.getElementById('dashboard-page');
        const fileList = document.getElementById('file-list');
        const newFileBtn = document.getElementById('new-file-btn');
        const newFolderBtn = document.getElementById('new-folder-btn');
        const breadcrumbBar = document.getElementById('breadcrumb-bar');
        const editorPage = document.getElementById('editor-page');
        const editorContainerWrapper = document.getElementById('editor-container-wrapper');
        const editorFilename = document.getElementById('editor-filename');
        const backButton = document.getElementById('back-button');
        const outputConsole = document.getElementById('output-console-modal');
        const outputHtmlFrame = document.getElementById('output-html-modal');
        const outputAnalysisModal = document.getElementById('output-analysis-modal');
        const runButton = document.getElementById('run-button');
        const modalOverlay = document.getElementById('result-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const clearConsoleButton = document.getElementById('clear-console-button');
        const executorIframe = document.getElementById('executor-iframe');
        const toggleDeviceButton = document.getElementById('toggle-device-button');
        const analyzeButton = document.getElementById('analyze-button');
        const gotoVisualBtn = document.getElementById('goto-visual-button');
        const gotoScriptBtn = document.getElementById('goto-script-button');
        const saveButton = document.getElementById('save-button');
        const modalTitle = document.getElementById('modal-title'); 
        const searchBar = document.getElementById('search-bar');
        const searchInput = document.getElementById('search-input');
        const searchPrev = document.getElementById('search-prev');
        const searchNext = document.getElementById('search-next');
        const searchClose = document.getElementById('search-close');
        const replaceRow = document.getElementById('replace-row');
        const replaceInput = document.getElementById('replace-input');
        const replaceOneBtn = document.getElementById('replace-one');
        const replaceAllBtn = document.getElementById('replace-all');
        const importFileBtn = document.getElementById('import-file-btn');
        const fileImporter = document.getElementById('file-importer');
        const layoutToggleBtn = document.getElementById('layout-toggle-btn');
        
        // --- ESTADO GLOBAL DA APLICAÇÃO ---
        let isMobileView = false;
        let currentFileId = null; 
        let currentFolderId = 'root'; 
        let breadcrumbStack = [{ id: 'root', name: 'Início' }];
        let currentLayout = 'grid'; 
        
        // --- CONSTANTES DO "BANCO DE DADOS" (LocalStorage) ---
        const DB_KEY = 'virtualFileSystem_v3'; 
        const LAYOUT_KEY = 'dashboardLayout_v3';
        const defaultJSCode = `// Seu código JS é salvo automaticamente!\nconsole.log("Olá, mundo!");`;
        const defaultHTMLCode = `<!DOCTYPE html>\n<html>\n<head>\n    <title>Olá</title>\n</head>\n<body>\n    <h1>Olá, mundo!</h1>\n\n    <script>\n        console.log("Script executado!");\n    <\/script>\n<\/body>\n</html>`;

        // =================================================================
        // INICIALIZAÇÃO DO CODEMIRROR
        // =================================================================
        const editor = CodeMirror(editorContainerWrapper, {
            value: '', theme: "monokai", lineNumbers: true, autoCloseBrackets: true,
            matchBrackets: true, indentUnit: 4, tabSize: 4, lineWrapping: true,
            styleSelectedText: true, highlightSelectionMatches: { showToken: /\w/, annotateScrollbar: true }
        });

        // =================================================================
        // LÓGICA DO "BANCO DE DADOS" (LocalStorage)
        // =================================================================
        function getFileSystem() { try { const db = localStorage.getItem(DB_KEY); return db ? JSON.parse(db) : []; } catch (e) { console.error("LS Read Error.", e); return []; } }
        function saveFileSystem(db) { try { localStorage.setItem(DB_KEY, JSON.stringify(db)); } catch (e) { console.error("LS Save Error.", e); alert("Erro ao salvar!"); } }
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 5); }

        // =================================================================
        // LÓGICA DE NAVEGAÇÃO ENTRE TELAS
        // =================================================================
        function showPage(pageName) {
             if (pageName === 'editor') {
                dashboardPage.classList.add('hide'); editorPage.classList.remove('hide');
                setTimeout(() => { editor.refresh(); editor.focus(); }, 50); 
            } else { editorPage.classList.add('hide'); dashboardPage.classList.remove('hide'); }
        }
        function openFile(fileId) { 
             const file = getFileSystem().find(item => item.id === fileId); if (!file) { alert("Erro: Arquivo não encontrado."); return; } currentFileId = file.id; editor.setValue(file.content || ''); editorFilename.textContent = file.name; const isHtml = file.type === 'html'; editor.setOption("mode", isHtml ? "htmlmixed" : "javascript"); analyzeButton.classList.toggle('hide', isHtml); gotoVisualBtn.classList.toggle('hide', !isHtml); gotoScriptBtn.classList.toggle('hide', !isHtml); showPage('editor');
        }
        function backToDashboard() { 
             if (currentFileId) saveCurrentFileContent(); currentFileId = null; showPage('dashboard'); renderDashboard(); 
        }

        // =================================================================
        // LÓGICA DO DASHBOARD (CRUD de Arquivos)
        // =================================================================
        function renderBreadcrumb() { 
             breadcrumbBar.innerHTML = ''; breadcrumbStack.forEach((crumb, index) => { const crumbEl = document.createElement('span'); crumbEl.textContent = crumb.name; crumbEl.onclick = () => { breadcrumbStack = breadcrumbStack.slice(0, index + 1); currentFolderId = crumb.id; renderDashboard(); }; breadcrumbBar.appendChild(crumbEl); if (index < breadcrumbStack.length - 1) breadcrumbBar.append(' / '); }); 
        }
        function renderDashboard() { 
             const db = getFileSystem(); fileList.innerHTML = ''; 
             fileList.className = currentLayout === 'list' ? 'list-view' : ''; 
             const items = db .filter(item => item.parentId === currentFolderId) .sort((a, b) => { if (a.type === 'folder' && b.type !== 'folder') return -1; if (a.type !== 'folder' && b.type === 'folder') return 1; return a.name.localeCompare(b.name); }); 
             if (items.length === 0) { fileList.innerHTML = '<p style="color: var(--text-muted); grid-column: 1 / -1; text-align: center;">Pasta vazia.</p>'; } 
             items.forEach(item => { 
                 const li = document.createElement('li'); li.className = 'file-item'; let iconClass = 'fas fa-file-alt'; if (item.type === 'folder') iconClass = 'fas fa-folder'; else if (item.type === 'js') iconClass = 'fab fa-js-square'; else if (item.type === 'html') iconClass = 'fab fa-html5'; li.innerHTML = ` <span class="file-icon"><i class="${iconClass}"></i></span> <span class="file-name">${item.name}</span> <div class="file-actions"> <button class="rename-btn" title="Renomear"><i class="fas fa-pencil-alt"></i></button> <button class="delete-btn" title="Deletar"><i class="fas fa-trash"></i></button> </div> `; li.onclick = () => { if (item.type === 'folder') { currentFolderId = item.id; breadcrumbStack.push({ id: item.id, name: item.name }); renderDashboard(); } else { openFile(item.id); } }; li.querySelector('.rename-btn').onclick = (e) => { e.stopPropagation(); renameItem(item.id); }; li.querySelector('.delete-btn').onclick = (e) => { e.stopPropagation(); deleteItem(item.id); }; fileList.appendChild(li); 
             }); 
             renderBreadcrumb(); 
             layoutToggleBtn.innerHTML = `<i class="fas ${currentLayout === 'grid' ? 'fa-list' : 'fa-th'}"></i>`;
        }
        
        function createNewItem(type = null) { 
             const isFolder = type === 'folder';
             let name = prompt(`Digite o nome ${isFolder ? 'da nova pasta' : 'do novo arquivo'}:`, isFolder ? 'Nova Pasta' : '');
             if (!name || name.trim() === '') return;
             name = name.trim();

             let finalType = type;
             
             if (!isFolder) {
                 if (name.endsWith('.js')) finalType = 'js';
                 else if (name.endsWith('.html') || name.endsWith('.htm')) finalType = 'html';
                 else {
                     // Pergunta o tipo se não houver extensão
                     const chosenType = prompt("Qual o tipo do arquivo? (js ou html)", "js");
                     if (chosenType === 'js') finalType = 'js';
                     else if (chosenType === 'html') finalType = 'html';
                     else { alert("Tipo inválido."); return; }
                     // Adiciona extensão se não tiver
                     if (finalType === 'js' && !name.endsWith('.js')) name += '.js';
                     if (finalType === 'html' && !/\.html?$/i.test(name)) name += '.html';
                 }
             } else {
                 finalType = 'folder'; 
             }

             const db = getFileSystem(); 
             if (db.some(item => item.parentId === currentFolderId && item.name.toLowerCase() === name.toLowerCase())) { alert("Erro: Nome já existe."); return; } 
             
             const newItem = { 
                 id: generateId(), type: finalType, name: name, parentId: currentFolderId, 
                 content: (finalType === 'js' ? defaultJSCode : (finalType === 'html' ? defaultHTMLCode : null)) 
             }; 
             db.push(newItem); saveFileSystem(db); renderDashboard(); 
        }
        
        function deleteItem(itemId) { 
             if (!confirm("Deletar este item e todo o seu conteúdo?\nEsta ação é irreversível.")) return; let db = getFileSystem(); let itemsToDelete = new Set([itemId]); const itemToDelete = db.find(item => item.id === itemId); if (itemToDelete && itemToDelete.type === 'folder') { let folderQueue = [itemId]; while (folderQueue.length > 0) { const parentId = folderQueue.pop(); db.forEach(item => { if (item.parentId === parentId) { itemsToDelete.add(item.id); if (item.type === 'folder') folderQueue.push(item.id); } }); } } db = db.filter(item => !itemsToDelete.has(item.id)); saveFileSystem(db); renderDashboard(); 
        }
        function renameItem(itemId) { 
             let db = getFileSystem(); const item = db.find(i => i.id === itemId); let newName = prompt("Digite o novo nome:", item.name); if (!newName || newName.trim() === '' || newName.trim() === item.name) return; newName = newName.trim(); if (item.type === 'js' && !newName.endsWith('.js')) newName += '.js'; if (item.type === 'html' && !/\.html?$/i.test(newName)) newName += '.html'; if (db.some(i => i.parentId === item.parentId && i.name.toLowerCase() === newName.toLowerCase() && i.id !== itemId)) { alert("Erro: Nome já existe nesta pasta."); return; } item.name = newName; saveFileSystem(db); renderDashboard(); 
        }
        
        function importFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                let name = file.name;
                let type = 'js'; 
                if (/\.html?$/i.test(name)) type = 'html';
                else if (!/\.js$/i.test(name)) { // Se não for html nem js, pergunta
                    const chosenType = prompt(`Importando "${name}". Qual o tipo? (js ou html)`, "js");
                    if (chosenType === 'html') type = 'html';
                    else if (chosenType !== 'js') { alert("Importação cancelada."); return; }
                }
                
                const db = getFileSystem();
                let counter = 1;
                let originalName = name;
                while (db.some(item => item.parentId === currentFolderId && item.name.toLowerCase() === name.toLowerCase())) {
                    const parts = originalName.match(/(.+)(\..+)?$/); // Captura nome e extensão
                    const baseName = parts[1];
                    const ext = parts[2] || '';
                    name = `${baseName}_${counter}${ext}`;
                    counter++;
                }

                const newItem = { id: generateId(), type: type, name: name, parentId: currentFolderId, content: content };
                db.push(newItem); saveFileSystem(db); renderDashboard();
            };
            reader.onerror = (e) => { alert("Erro ao ler o arquivo."); console.error("FileReader error:", e); };
            reader.readAsText(file);
        }

        function toggleLayout() {
            currentLayout = (currentLayout === 'grid' ? 'list' : 'grid');
            try { localStorage.setItem(LAYOUT_KEY, currentLayout); } catch (e) {}
            renderDashboard();
        }
        
        // =================================================================
        // LÓGICA DO EDITOR
        // =================================================================
        let saveTimeout; function saveCurrentFileContent() { if (!currentFileId) return; try { const db = getFileSystem(); const file = db.find(item => item.id === currentFileId); if (file) { file.content = editor.getValue(); saveFileSystem(db); } } catch (e) { console.warn("LS blocked. Save failed.", e); } } editor.on("change", () => { clearTimeout(saveTimeout); saveTimeout = setTimeout(saveCurrentFileContent, 1000); });
        function openSearch(showReplace = false) { searchBar.classList.remove('hide'); if (showReplace) { replaceRow.classList.remove('hide'); replaceOneBtn.classList.remove('hide'); replaceAllBtn.classList.remove('hide'); } else { replaceRow.classList.add('hide'); replaceOneBtn.classList.add('hide'); replaceAllBtn.classList.add('hide'); } searchInput.focus(); searchInput.select(); } function closeSearch() { searchBar.classList.add('hide'); editor.focus(); } function doSearch(reverse = false) { const query = searchInput.value; if (!query) return; editor.execCommand(reverse ? "findPrev" : "findNext"); } function doReplaceOne() { const query = searchInput.value; const replace = replaceInput.value; if (editor.getSelection().toLowerCase() === query.toLowerCase()) editor.replaceSelection(replace); doSearch(); } function doReplaceAll() { const query = searchInput.value; const replace = replaceInput.value; if (!query) return; editor.focus(); let cursor = editor.getSearchCursor(query, {line: 0}, true); while (cursor.findNext()) cursor.replace(replace); } editor.on("keydown", (cm, event) => { if (event.key === "f" && (event.ctrlKey || event.metaKey)) { event.preventDefault(); openSearch(false); } if (event.key === "g" && (event.ctrlKey || event.metaKey)) { event.preventDefault(); openSearch(false); } if (event.key === "S" && event.shiftKey && (event.ctrlKey || event.metaKey)) { event.preventDefault(); openSearch(true); } if (event.key === "Escape" && !searchBar.classList.contains('hide')) { event.preventDefault(); closeSearch(); } }); searchNext.addEventListener('click', () => doSearch()); searchPrev.addEventListener('click', () => doSearch(true)); searchClose.addEventListener('click', closeSearch); replaceOneBtn.addEventListener('click', doReplaceOne); replaceAllBtn.addEventListener('click', doReplaceAll); searchInput.addEventListener('input', () => editor.execCommand("find", searchInput.value)); searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); doSearch(e.shiftKey); } });
        function showModal() { modalOverlay.style.display = 'flex'; } function hideModal() { modalOverlay.style.display = 'none'; outputHtmlFrame.srcdoc = ''; if (isMobileView) toggleDeviceView(); } function clearConsole() { outputConsole.innerHTML = ''; } function clearAllHighlights() { editor.eachLine(line => { editor.removeLineClass(line, 'background', 'line-error-background'); editor.removeLineClass(line, 'background', 'line-suggestion-background'); }); } function highlightErrorLine(lineNumber) { if (lineNumber > 0) editor.addLineClass(lineNumber - 1, 'background', 'line-error-background'); } function highlightSuggestionLine(lineNumber) { if (lineNumber > 0) editor.addLineClass(lineNumber - 1, 'background', 'line-suggestion-background'); } function logToConsole(data) { const line = document.createElement('div'); line.className = `output-line output-${data.type || 'log'}`; line.textContent = (typeof data.message === 'object') ? JSON.stringify(data.message, null, 2) : data.message; outputConsole.appendChild(line); outputConsole.scrollTop = outputConsole.scrollHeight; } function toggleDeviceView() { isMobileView = !isMobileView; outputHtmlFrame.classList.toggle('mobile-view', isMobileView); toggleDeviceButton.innerHTML = isMobileView ? '<i class="fas fa-desktop"></i> Desktop' : '<i class="fas fa-mobile-alt"></i> Celular'; } function setModalMode(mode) { outputConsole.style.display = 'none'; outputHtmlFrame.style.display = 'none'; outputAnalysisModal.style.display = 'none'; clearConsoleButton.style.display = 'none'; toggleDeviceButton.style.display = 'none'; if (isMobileView) toggleDeviceView(); if (mode === 'html') { modalTitle.textContent = "Renderização HTML"; outputHtmlFrame.style.display = 'block'; toggleDeviceButton.style.display = 'inline-flex'; } else if (mode === 'js') { modalTitle.textContent = "Saída (Console)"; outputConsole.style.display = 'block'; clearConsoleButton.style.display = 'inline-flex'; } else if (mode === 'analysis') { modalTitle.textContent = "Análise Estática"; outputAnalysisModal.style.display = 'block'; } }
        window.addEventListener('message', (event) => { if (event.source !== executorIframe.contentWindow) return; const data = event.data; if (data.type === 'error' && data.line) highlightErrorLine(data.line); if (data.type === 'done') logToConsole({ type: 'done', message: 'Execução concluída.' }); else logToConsole(data); });
        function runCode() { clearAllHighlights(); const code = editor.getValue(); const file = getFileSystem().find(f => f.id === currentFileId); if (!file) return; if (file.type === 'html') { setModalMode('html'); outputHtmlFrame.srcdoc = code; } else { setModalMode('js'); clearConsole(); const iframeContent = `<!DOCTYPE html><html><head><title>Executor</title></head><body><script> const postLog=(type,args,line=null)=>{try{const message=args.map(a=>(typeof a==='object'?JSON.stringify(a,null,2):String(a))).join(' ');window.parent.postMessage({type:type,message:message,line:line},'*')}catch(e){window.parent.postMessage({type:'error',message:'Erro ao registrar log',line:line},'*')}}; console.log=(...args)=>{postLog('log',args)};console.warn=(...args)=>{postLog('warn',args)};console.error=(...args)=>{postLog('error',args)};console.info=(...args)=>{postLog('info',args)}; window.onerror=(message,source,lineno)=>{postLog('error',['Erro não capturado:',message],lineno)};window.onunhandledrejection=(event)=>{postLog('error',['Promise Rejeitada:',event.reason])}; try{eval(${JSON.stringify(code)})}catch(e){let lineNumber=null;if(e.stack){const match=e.stack.match(/<anonymous>:(\\d+):(\\d+)/);if(match&&match[1])lineNumber=parseInt(match[1])}postLog('error',['ERRO:',e.message],lineNumber)} setTimeout(()=>{window.parent.postMessage({type:'done'},'*')},50); <\/script></body></html>`; executorIframe.srcdoc = iframeContent; } showModal(); }
        function simpleLinter(code) { const issues = []; const lines = code.split('\n'); lines.forEach((lineText, index) => { const lineNumber = index + 1; if (/\bvar\b/.test(lineText)) issues.push({ line: lineNumber, message: "Evite 'var'. Prefira 'let' ou 'const'.", type: 'suggestion' }); if (/==(?!=)/.test(lineText)) issues.push({ line: lineNumber, message: "Prefira '===' em vez de '=='.", type: 'suggestion' }); if (/console\.log/.test(lineText)) issues.push({ line: lineNumber, message: "Remover 'console.log' em produção.", type: 'info' }); }); return issues; } function runCodeAnalysis() { const code = editor.getValue(); setModalMode('analysis'); showModal(); clearAllHighlights(); const issues = simpleLinter(code); let htmlResponse = ''; if (issues.length === 0) { htmlResponse = `<h3><i class="fas fa-check-circle" style="color: #4CAF50;"></i> Tudo Certo!</h3><p>Nenhuma sugestão encontrada.</p>`; } else { htmlResponse = `<h3><i class="fas fa-search"></i> Análise</h3><p>Encontrado${issues.length > 1 ? 's' : ''} ${issues.length} ponto${issues.length > 1 ? 's' : ''}:</p><ul>`; issues.forEach(issue => { const icon = issue.type === 'suggestion' ? '<i class="fas fa-lightbulb"></i>' : '<i class="fas fa-info-circle"></i>'; htmlResponse += `<li>${icon} <span class="line-ref">Linha ${issue.line}</span><p>${issue.message}</p></li>`; highlightSuggestionLine(issue.line); }); htmlResponse += `</ul>`; } outputAnalysisModal.innerHTML = htmlResponse; }
        function gotoSection(regex, fallbackRegex = null) { editor.focus(); let cursor = editor.getSearchCursor(regex, {line: 0}); if (!cursor.findNext()) { if (fallbackRegex) { cursor = editor.getSearchCursor(fallbackRegex, {line: 0}); if (!cursor.findNext()) { editor.setCursor({line: 0, ch: 0}); return; } } else { editor.setCursor({line: 0, ch: 0}); return; } } editor.setSelection(cursor.from(), cursor.to()); }
        function saveCodeToDisk() { const file = getFileSystem().find(f => f.id === currentFileId); if (!file) { alert("Nenhum arquivo aberto."); return; } let filename; try { filename = prompt("Nome do arquivo:", file.name); } catch (e) { alert("Prompt bloqueado. Verifique pop-ups."); return; } if (filename === null || filename.trim() === "") return; if (file.type === 'html' && !/\.html?$/i.test(filename)) filename += '.html'; else if (file.type === 'js' && !filename.endsWith('.js')) filename += '.js'; const code = editor.getValue(); const mimeType = file.type === 'html' ? 'text/html' : 'text/javascript'; const blob = new Blob([code], {type: `${mimeType};charset=utf-8`}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }

        // =================================================================
        // INICIALIZAÇÃO DA APLICAÇÃO
        // =================================================================
        newFileBtn.addEventListener('click', () => createNewItem()); 
        newFolderBtn.addEventListener('click', () => createNewItem('folder'));
        backButton.addEventListener('click', backToDashboard);
        runButton.addEventListener('click', runCode);
        analyzeButton.addEventListener('click', runCodeAnalysis);
        saveButton.addEventListener('click', saveCodeToDisk); 
        gotoVisualBtn.addEventListener('click', () => gotoSection(/<body/i, /<div|<h1|<main|<section|<header|<button|<style/i));
        gotoScriptBtn.addEventListener('click', () => gotoSection(/<script/i));
        closeModalButton.addEventListener('click', hideModal);
        clearConsoleButton.addEventListener('click', clearConsole);
        toggleDeviceButton.addEventListener('click', toggleDeviceView);
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) hideModal(); });
        importFileBtn.addEventListener('click', () => fileImporter.click());
        fileImporter.addEventListener('change', (e) => { if (e.target.files.length > 0) importFile(e.target.files[0]); e.target.value = null; });
        layoutToggleBtn.addEventListener('click', toggleLayout);

        document.addEventListener('DOMContentLoaded', () => {
            try { currentLayout = localStorage.getItem(LAYOUT_KEY) || 'grid'; } catch(e) {}
            renderDashboard(); 
        });

    </script>
</body>
</html>
